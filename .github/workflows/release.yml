name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install frontend dependencies
      run: pnpm install --filter frontend

    - name: Build release
      run: cargo build --release

    - name: Prepare release directory
      run: |
        mkdir release
        cp -r target/release/ release/
        cp -r assets release/assets

    - name: Create archive
      run: |
        cd release
        zip -r ../${{ github.ref_name }}.zip .
        cd ..

    - name: Upload release asset
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ github.ref_name }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
